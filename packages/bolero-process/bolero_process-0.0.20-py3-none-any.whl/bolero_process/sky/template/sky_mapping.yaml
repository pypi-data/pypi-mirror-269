# jupyter.yaml

resources:
  cloud: gcp
  instance_type: { instance }
  region: { region }
  disk_size: { disk_size }
  image_id: projects/hms-dev-greenberg-4923/global/images/hanqing-analysis-base

file_mounts:
  /data:
    source: gs://hms-hanqing-analysis
    mode: MOUNT
  /ref:
    source: gs://hms-hanqing-reference
    mode: MOUNT
  /wmb:
    source: gs://hms-hanqing-wmb
    mode: MOUNT
  /tempdata:
    source: gs://hms-hanqing-temp
    mode: MOUNT

setup: |
  if [ -f $HOME/mambaforge/SKIPSETUP ]
  then
    echo "Skip setup"
  else
    gsutil -m cp gs://hms-hanqing-reference/pkg/env.yml /tmp/env.yml
    mamba env update -n base -f /tmp/env.yml
    mamba install -y bowtie2 samtools picard deeptools bedtools macs2 STAR kallisto==0.46 subread multiqc trim-galore
    touch $HOME/mambaforge/SKIPSETUP
  fi

run: |
  nohup jupyter-lab --LabApp.token='' --no-browser --port 9393 &
  snakemake -d /tempdata/cemba_atac -s /tempdata/cemba_atac/Snakefile --keep-going --rerun-incomplete -j --nolock
